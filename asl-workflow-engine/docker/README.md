# Docker

An Alpine based [Dockerfile](Dockerfile) for the [asl-workflow-engine](..) is as follows:

```dockerfile
FROM python:3.6-alpine

COPY py/asl_workflow_engine /usr/local/lib/asl_workflow_engine/asl_workflow_engine
COPY py/setup.py /usr/local/lib/asl_workflow_engine
COPY py/workflow_engine /usr/local/bin

# update-ca-certificates generates a somewhat confusing/worrying warning:
# WARNING: ca-certificates.crt does not contain exactly one certificate or CRL: skipping
# This is however apparently "normal" (though other Linux distros don't do this)
# https://github.com/gliderlabs/docker-alpine/issues/30
# Explicitly add libstdc++ as its used by ujson
RUN apk update && apk upgrade && \
    apk add ca-certificates libstdc++ gcc g++ && \
    update-ca-certificates && \
    pip install -e /usr/local/lib/asl_workflow_engine && \
    # Remove packages only needed during installation from runtime container
    pip uninstall -y setuptools wheel pip && \
    apk del gcc g++ && \
    rm -rf /var/cache/apk/* && \
    # Add unprivileged "asluser" group and user. The uid/gid
    # chosen is a bit arbitrary and 55674 doesn't have any
    # particular significance.
    addgroup -S -g 55674 asluser && \
    adduser -S -u 55674 -G asluser asluser

USER asluser

WORKDIR /tmp

ENTRYPOINT ["/usr/local/bin/workflow_engine"]
```

To build the image:

```bash
docker build -t asl-workflow-engine -f ./Dockerfile ..
```

Note that this uses `..` not `.` to reference the Docker context as we need to look in the parent directory.

To launch an asl-workflow-engine container instance:

```bash
mkdir -p asl_store
docker run --rm -it \
    -u $(id -u):$(id -g) \
    -p 4584:4584 \
    -e USE_STRUCTURED_LOGGING=TRUE \
    -e EVENT_QUEUE_CONNECTION_URL="amqp://$(hostname -I | awk '{print $1}'):5672?connection_attempts=20&retry_delay=10&heartbeat=0" \
    -e EVENT_QUEUE_QUEUE_IMPLEMENTATION="AMQP-0.9.1-asyncio" \
    -e JAEGER_AGENT_HOST=$(hostname -I | awk '{print $1}') \
    -v $PWD/asl_store:/tmp \
    asl-workflow-engine
```

This example launch script makes use of the USE_STRUCTURED_LOGGING and EVENT_QUEUE_CONNECTION_URL environment variables. The configuration environment variables are described in detail in the [Configuration](../documentation/configuration.md) section of the documentation.

### Container hardening
By way of experimentation and interest this directory contains a proof of concept for running the asl-workflow-engine in a more "locked down" way.

To do this we first build a modified image that adds the `strace` executable and modifies the ENTRYPOINT to run the application using strace.

```dockerfile
FROM asl-workflow-engine

# Switch to root user needed for adding packages
USER root

RUN apk update && apk upgrade && \
    apk add strace

# Switch back to unprivileged asluser
USER asluser

ENTRYPOINT ["strace", "-f", "-o", "/tmp/asl-strace.log", "/usr/local/bin/workflow_engine"]
```

We then run that image in place of our main asl-workflow-engine as follows:

```bash
mkdir -p asl_store
docker run --rm -it \
    -u $(id -u):$(id -g) \
    -p 4584:4584 \
    -e USE_STRUCTURED_LOGGING=TRUE \
    -e EVENT_QUEUE_CONNECTION_URL="amqp://$(hostname -I | awk '{print $1}'):5672?connection_attempts=20&retry_delay=10&heartbeat=0" \
    -e EVENT_QUEUE_QUEUE_IMPLEMENTATION="AMQP-0.9.1-asyncio" \
    -e JAEGER_AGENT_HOST=$(hostname -I | awk '{print $1}') \
    -v $PWD/asl_store:/tmp \
    asl-workflow-engine-strace
```

In essence this runs the application using strace and writes the strace.log to the bind-mounted directory.

Given a strace.log that has been generated by **fully exercising** the application we can use a tool to generate the seccomp profile seccomp.json.

This seccomp profile *allows* 70 syscalls blocking the rest, which is a significantly smaller syscall footprint than the default Docker seccomp profile which blocks around 44 out of over 300 available Linux syscalls.

To launch asl-workflow-engine in a more locked-down way:

```bash
mkdir -p asl_store
docker run --rm -it \
    --security-opt no-new-privileges \
    --security-opt seccomp=$PWD/seccomp.json \
    --cap-drop all \
    --read-only \
    -u $(id -u):$(id -g) \
    -p 4584:4584 \
    -e USE_STRUCTURED_LOGGING=FALSE \
    -e EVENT_QUEUE_CONNECTION_URL="amqp://$(hostname -I | awk '{print $1}'):5672?connection_attempts=20&retry_delay=10&heartbeat=0" \
    -e EVENT_QUEUE_QUEUE_IMPLEMENTATION="AMQP-0.9.1-asyncio" \
    -e JAEGER_AGENT_HOST=$(hostname -I | awk '{print $1}') \
    -v $PWD/asl_store:/tmp \
    asl-workflow-engine
```

The `--security-opt no-new-privileges` prevents privilege elevation like suid, su, sudo and in addition applies the seccomp profile after container initiation which allows a much 'tighter' seccomp profile to be used.

In addition to a custom seccomp profile we do `--cap-drop all` as the application does not require any additional capabilities and we make the root filesystem readonly by `--read-only`
